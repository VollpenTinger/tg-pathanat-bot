import asyncio
import json
import os
import random
from typing import List, Dict, Any

from aiogram import Bot, Dispatcher, F
from aiogram.filters import CommandStart, Command
from aiogram.types import (
    Message, CallbackQuery,
    InlineKeyboardMarkup, InlineKeyboardButton,
    ReplyKeyboardMarkup, KeyboardButton,
    FSInputFile
)

# ----------------------------------------------------------
# TOKEN: –º–æ–∂–Ω–æ –≤–ø–∏—Å–∞—Ç—å —Å—é–¥–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ –õ–û–ö–ê–õ–¨–ù–û:
# BOT_TOKEN = "8245340349:AAF2sB8Gn5dXiqQQ1ldxAHqk_wpsdcLrH2c"


# –Ω–æ –¥–ª—è Render —Ç–æ–∫–µ–Ω –±—É–¥–µ—Ç –≤ Environment Variables:
BOT_TOKEN = os.getenv("BOT_TOKEN")

if not BOT_TOKEN:
    raise RuntimeError("–ù–µ –Ω–∞–π–¥–µ–Ω BOT_TOKEN. –£–∫–∞–∂–∏ –µ–≥–æ –≤ Render.")

PREPARATS_DIR = "preparats"

bot = Bot(BOT_TOKEN, parse_mode="HTML")
dp = Dispatcher()

SPECIMENS: List[Dict[str, Any]] = []
user_state: Dict[int, Dict[str, Any]] = {}


# ----------------------------------------------------------
# –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤
# ----------------------------------------------------------

def load_preparats_from_folders(base_path=PREPARATS_DIR):
    all_preps = []
    if not os.path.exists(base_path):
        os.makedirs(base_path, exist_ok=True)
        return all_preps

    current_id = 1
    for folder in sorted(os.listdir(base_path)):
        folder_path = os.path.join(base_path, folder)
        if not os.path.isdir(folder_path):
            continue

        info_file = os.path.join(folder_path, "info.json")
        if not os.path.exists(info_file):
            continue

        with open(info_file, "r", encoding="utf-8") as f:
            data = json.load(f)

        name = data.get("name")
        if not name:
            continue

        difficulty = data.get("difficulty", "easy")
        aliases = data.get("aliases", [])

        images = []
        for file in sorted(os.listdir(folder_path)):
            if file.lower().endswith((".jpg", ".jpeg", ".png")):
                images.append(os.path.join(folder_path, file))

        if not images:
            continue

        all_preps.append({
            "id": current_id,
            "name": name,
            "difficulty": difficulty,
            "aliases": aliases,
            "images": images
        })

        current_id += 1

    return all_preps


def normalize_text(t: str):
    return t.strip().lower().replace("—ë", "–µ")


def get_specimens_by_difficulty(diff):
    if diff is None:
        return SPECIMENS
    selected = [s for s in SPECIMENS if s["difficulty"] == diff]
    return selected or SPECIMENS


def get_random_specimen(diff=None):
    return random.choice(get_specimens_by_difficulty(diff))


def get_specimen_by_id(spec_id):
    for s in SPECIMENS:
        if s["id"] == spec_id:
            return s


# ----------------------------------------------------------
# –ö–Ω–æ–ø–∫–∏
# ----------------------------------------------------------

def main_menu_keyboard():
    return ReplyKeyboardMarkup(
        keyboard=[
            [KeyboardButton(text="üìö –û–±—É—á–µ–Ω–∏–µ")],
            [KeyboardButton(text="üß™ –¢–µ—Å—Ç (–ª—ë–≥–∫–∏–π)"), KeyboardButton(text="üî• –¢–µ—Å—Ç (—Å–ª–æ–∂–Ω—ã–π)")]
        ],
        resize_keyboard=True
    )


def next_button_keyboard(mode):
    return InlineKeyboardMarkup(
        inline_keyboard=[[InlineKeyboardButton(text="‚û°Ô∏è –î–∞–ª–µ–µ", callback_data=f"next:{mode}")]]
    )


# ----------------------------------------------------------
# –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ
# ----------------------------------------------------------

async def send_specimen_image(chat_id, specimen, text, kb=None):
    img = random.choice(specimen["images"])
    if os.path.exists(img):
        await bot.send_photo(chat_id, FSInputFile(img), caption=text, reply_markup=kb)
    else:
        await bot.send_message(chat_id, text, reply_markup=kb)


# ----------------------------------------------------------
# Handlers
# ----------------------------------------------------------

@dp.message(CommandStart())
async def start_cmd(msg: Message):
    await msg.answer(
        "–ü—Ä–∏–≤–µ—Ç! üëã\n–Ø –±–æ—Ç –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ –º–∏–∫—Ä–æ–ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤.\n\n"
        "–í—ã–±–µ—Ä–∏ —Ä–µ–∂–∏–º:",
        reply_markup=main_menu_keyboard()
    )


# ---- –û–±—É—á–µ–Ω–∏–µ ----

@dp.message(F.text == "üìö –û–±—É—á–µ–Ω–∏–µ")
async def training(msg: Message):
    specimen = get_random_specimen()
    text = f"<b>{specimen['name']}</b>"
    await send_specimen_image(msg.chat.id, specimen, text, next_button_keyboard("train"))


# ---- –õ—ë–≥–∫–∏–π —Ç–µ—Å—Ç ----

@dp.message(F.text == "üß™ –¢–µ—Å—Ç (–ª—ë–≥–∫–∏–π)")
async def easy_test(msg: Message):
    specimen = get_random_specimen("easy")

    others = [s for s in SPECIMENS if s["id"] != specimen["id"]]
    options = [specimen["name"]] + [s["name"] for s in random.sample(others, min(3, len(others)))]
    random.shuffle(options)

    user_state[msg.from_user.id] = {
        "mode": "easy",
        "specimen_id": specimen["id"],
        "options": options,
        "correct": specimen["name"]
    }

    kb = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(text=o, callback_data=f"opt:{i}")]
            for i, o in enumerate(options)
        ]
    )

    await send_specimen_image(msg.chat.id, specimen, "–í—ã–±–µ—Ä–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç:", kb)


@dp.callback_query(F.data.startswith("opt:"))
async def easy_answer(cb: CallbackQuery):
    user = user_state.get(cb.from_user.id)
    if not user or user["mode"] != "easy":
        await cb.answer("–ù–∞—á–Ω–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ.")
        return

    chosen_idx = int(cb.data.split(":")[1])
    chosen = user["options"][chosen_idx]
    correct = user["correct"]

    if chosen == correct:
        text = f"‚úÖ –í–µ—Ä–Ω–æ!\n<b>{correct}</b>"
    else:
        text = f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\n–ü—Ä–∞–≤–∏–ª—å–Ω–æ: <b>{correct}</b>"

    await cb.message.answer(text, reply_markup=next_button_keyboard("easy"))
    await cb.answer()


# ---- –°–ª–æ–∂–Ω—ã–π —Ç–µ—Å—Ç ----

@dp.message(F.text == "üî• –¢–µ—Å—Ç (—Å–ª–æ–∂–Ω—ã–π)")
async def hard(msg: Message):
    specimen = get_random_specimen("hard")
    user_state[msg.from_user.id] = {"mode": "hard", "specimen_id": specimen["id"]}

    await send_specimen_image(
        msg.chat.id, specimen,
        "–í–ø–∏—à–∏ <b>—Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</b> –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:"
    )


@dp.message()
async def hard_answer(msg: Message):
    user = user_state.get(msg.from_user.id)
    if not user or user["mode"] != "hard":
        return

    specimen = get_specimen_by_id(user["specimen_id"])
    answer = normalize_text(msg.text)

    names = [normalize_text(specimen["name"])] + [normalize_text(a) for a in specimen["aliases"]]

    if any(answer == n or answer in n or n in answer for n in names):
        text = f"‚úÖ –í–µ—Ä–Ω–æ! –≠—Ç–æ <b>{specimen['name']}</b>"
    else:
        text = f"‚ùå –ù–µ–≤–µ—Ä–Ω–æ.\n–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç: <b>{specimen['name']}</b>"

    await msg.answer(text, reply_markup=next_button_keyboard("hard"))


# ----------------------------------------------------------
# NEXT
# ----------------------------------------------------------

@dp.callback_query(F.data.startswith("next:"))
async def next_q(cb: CallbackQuery):
    _, mode = cb.data.split(":")
    if mode == "train":
        await training(cb.message)
    elif mode == "easy":
        await easy_test(cb.message)
    elif mode == "hard":
        await hard(cb.message)

    await cb.answer()


# ----------------------------------------------------------
# Main
# ----------------------------------------------------------

async def main():
    global SPECIMENS
    SPECIMENS = load_preparats_from_folders()
    await dp.start_polling(bot)


if __name__ == "__main__":
    asyncio.run(main())